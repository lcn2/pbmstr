/*
 * pbmtext - form a pbm file using builtin fixed font from args
 *
 * usage:
 *	pbmtext line1 line2 longer_line3 last_line > foo.pbm
 *
 * @(#) $Revision: 1.1 $
 * @(#) $Id: pbmtext.c,v 1.1 2001/01/27 19:10:29 chongo Exp chongo $
 * @(#) $Source: /usr/local/src/cmd/pbmtext/RCS/pbmtext.c,v $
 *
 * Copyright (c) 2000 by Landon Curt Noll.  All Rights Reserved.
 *
 * Permission to use, copy, modify, and distribute this software and
 * its documentation for any purpose and without fee is hereby granted,
 * provided that the above copyright, this permission notice and text
 * this comment, and the disclaimer below appear in all of the following:
 *
 *       supporting documentation
 *       source copies
 *       source works derived from this source
 *       binaries derived from this source or from derived source
 *
 * LANDON CURT NOLL DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE,
 * INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO
 * EVENT SHALL LANDON CURT NOLL BE LIABLE FOR ANY SPECIAL, INDIRECT OR
 * CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF
 * USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
 * OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
 * PERFORMANCE OF THIS SOFTWARE.
 *
 * chongo <was here> /\oo/\
 *
 * Share and enjoy!
 */

#include <stdio.h>
#include <string.h>


/*
 * builtin 8x13 fixed font - constructed by b64.chopup.sh
 *
 * alphabet[i] - the i-th character (0 <= i <= 64)
 * charnum[c]  - alphabet index of character c, c == alphabet[charnum[(int)c]]
 * font[c]     - array of GLYPH_PIXEL_ROWS octets for PBM font glyph
 * font[c][r]  - row r of char c of PBM font glyph
 */
#define ALPHABET_LEN 65		/* glyphs in alphabet + trailing space */
#define GLYPH_PIXEL_ROWS 13	/* font is this many pixels high (8x13 font) */
#define GLYPH_PIXEL_COLS 8	/* font is this many pixels wide (8x13 font) */
unsigned char alphabet[ALPHABET_LEN] =
    "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz/. ";
int charnum[256] = {
    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,  /* 00-0f */
    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,  /* 10-1f */
    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 62, 63,  /* 20-2f */
     0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 64, 64, 64, 64, 64, 64,  /* 30-3f */
    64, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24,  /* 40-4f */
    25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 64, 64, 64, 64, 64,  /* 50-5f */
    64, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50,  /* 60-6f */
    51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 64, 64, 64, 64, 64,  /* 70-7f */
    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,  /* 80-0f */
    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,  /* 90-9f */
    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,  /* a0-af */
    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,  /* b0-bf */
    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,  /* c0-cf */
    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,  /* d0-df */
    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,  /* e0-ef */
    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64   /* f0-ff */
};
unsigned char font[ALPHABET_LEN][GLYPH_PIXEL_ROWS] = {
    {0xe3,0xdd,0xdd,0xdd,0xdd,0xdd,0xdd,0xdd,0xe3,0xff,0xff,0xff,0xff}, /* 0 */
    {0xf7,0xc7,0xf7,0xf7,0xf7,0xf7,0xf7,0xf7,0xc1,0xff,0xff,0xff,0xff}, /* 1 */
    {0xe3,0xdd,0xdd,0xdd,0xfb,0xf7,0xef,0xdd,0xc1,0xff,0xff,0xff,0xff}, /* 2 */
    {0xe3,0xdd,0xfd,0xfd,0xf3,0xfd,0xfd,0xdd,0xe3,0xff,0xff,0xff,0xff}, /* 3 */
    {0xfb,0xf3,0xeb,0xeb,0xdb,0xbb,0x81,0xfb,0xf1,0xff,0xff,0xff,0xff}, /* 4 */
    {0xc1,0xdf,0xdf,0xdf,0xc3,0xfd,0xfd,0xbd,0xc3,0xff,0xff,0xff,0xff}, /* 5 */
    {0xf1,0xef,0xdf,0xdf,0xc3,0xdd,0xdd,0xdd,0xe3,0xff,0xff,0xff,0xff}, /* 6 */
    {0xc1,0xdd,0xfb,0xfb,0xfb,0xfb,0xf7,0xf7,0xf7,0xff,0xff,0xff,0xff}, /* 7 */
    {0xe3,0xdd,0xdd,0xdd,0xe3,0xdd,0xdd,0xdd,0xe3,0xff,0xff,0xff,0xff}, /* 8 */
    {0xe3,0xdd,0xdd,0xdd,0xdd,0xe1,0xfd,0xfb,0xc7,0xff,0xff,0xff,0xff}, /* 9 */
    {0xff,0xc7,0xf7,0xeb,0xeb,0xc1,0xdd,0xdd,0x88,0xff,0xff,0xff,0xff}, /* A */
    {0xff,0x83,0xdd,0xdd,0xc3,0xdd,0xdd,0xdd,0x83,0xff,0xff,0xff,0xff}, /* B */
    {0xff,0xe3,0xdd,0xdd,0xdf,0xdf,0xdd,0xdd,0xe3,0xff,0xff,0xff,0xff}, /* C */
    {0xff,0x83,0xdd,0xdd,0xdd,0xdd,0xdd,0xdd,0x83,0xff,0xff,0xff,0xff}, /* D */
    {0xff,0x81,0xdd,0xd7,0xc7,0xd7,0xdf,0xdd,0x81,0xff,0xff,0xff,0xff}, /* E */
    {0xff,0x81,0xdd,0xd5,0xc7,0xd7,0xdf,0xdf,0x87,0xff,0xff,0xff,0xff}, /* F */
    {0xff,0xe3,0xdd,0xdd,0xdf,0xd9,0xdd,0xdd,0xe3,0xff,0xff,0xff,0xff}, /* G */
    {0xff,0x88,0xdd,0xdd,0xc1,0xdd,0xdd,0xdd,0x88,0xff,0xff,0xff,0xff}, /* H */
    {0xff,0xc1,0xf7,0xf7,0xf7,0xf7,0xf7,0xf7,0xc1,0xff,0xff,0xff,0xff}, /* I */
    {0xff,0xe1,0xfb,0xfb,0xfb,0xfb,0xdb,0xdb,0xe7,0xff,0xff,0xff,0xff}, /* J */
    {0xff,0x89,0xdb,0xd7,0xcf,0xc7,0xdb,0xdd,0x8c,0xff,0xff,0xff,0xff}, /* K */
    {0xff,0x8f,0xdf,0xdf,0xdf,0xdf,0xdd,0xdd,0x81,0xff,0xff,0xff,0xff}, /* L */
    {0xff,0x9c,0xc9,0xc9,0xd5,0xd5,0xd5,0xdd,0x88,0xff,0xff,0xff,0xff}, /* M */
    {0xff,0x98,0xcd,0xcd,0xd5,0xd5,0xd9,0xd9,0x8d,0xff,0xff,0xff,0xff}, /* N */
    {0xff,0xe3,0xdd,0xdd,0xdd,0xdd,0xdd,0xdd,0xe3,0xff,0xff,0xff,0xff}, /* O */
    {0xff,0x83,0xd9,0xdd,0xd9,0xc3,0xdf,0xdf,0x87,0xff,0xff,0xff,0xff}, /* P */
    {0xff,0xe3,0xdd,0xdd,0xdd,0xdd,0xdd,0xdd,0xe3,0xf9,0xff,0xff,0xff}, /* Q */
    {0xff,0x83,0xdd,0xdd,0xc3,0xdb,0xdd,0xdd,0x8c,0xff,0xff,0xff,0xff}, /* R */
    {0xff,0xe1,0xdd,0xdf,0xc7,0xf1,0xfd,0xdd,0xc3,0xff,0xff,0xff,0xff}, /* S */
    {0xff,0x80,0xb6,0xb6,0xf7,0xf7,0xf7,0xf7,0xc1,0xff,0xff,0xff,0xff}, /* T */
    {0xff,0x88,0xdd,0xdd,0xdd,0xdd,0xdd,0xc9,0xe3,0xff,0xff,0xff,0xff}, /* U */
    {0xff,0x88,0xdd,0xdd,0xc9,0xeb,0xeb,0xe3,0xf7,0xff,0xff,0xff,0xff}, /* V */
    {0xff,0x88,0xdd,0xd5,0xd5,0xd5,0xc9,0xeb,0xeb,0xff,0xff,0xff,0xff}, /* W */
    {0xff,0x88,0xdd,0xeb,0xf7,0xeb,0xeb,0xdd,0x88,0xff,0xff,0xff,0xff}, /* X */
    {0xff,0x88,0xdd,0xeb,0xeb,0xf7,0xf7,0xf7,0xe3,0xff,0xff,0xff,0xff}, /* Y */
    {0xff,0xc1,0xdd,0xdb,0xf7,0xf7,0xed,0xdd,0xc1,0xff,0xff,0xff,0xff}, /* Z */
    {0xff,0xff,0xff,0xc3,0xfd,0xe1,0xdd,0xdd,0xe2,0xff,0xff,0xff,0xff}, /* a */
    {0x9f,0xdf,0xdf,0xc3,0xdd,0xdd,0xdd,0xdd,0xa3,0xff,0xff,0xff,0xff}, /* b */
    {0xff,0xff,0xff,0xe3,0xdd,0xdf,0xdf,0xdd,0xe3,0xff,0xff,0xff,0xff}, /* c */
    {0xf9,0xfd,0xfd,0xe1,0xdd,0xdd,0xdd,0xdd,0xe2,0xff,0xff,0xff,0xff}, /* d */
    {0xff,0xff,0xff,0xe3,0xdd,0xc1,0xdf,0xdd,0xe3,0xff,0xff,0xff,0xff}, /* e */
    {0xf1,0xef,0xef,0xc1,0xef,0xef,0xef,0xef,0xc3,0xff,0xff,0xff,0xff}, /* f */
    {0xff,0xff,0xff,0xe2,0xdd,0xdd,0xdd,0xdd,0xe1,0xfd,0xfd,0xe3,0xff}, /* g */
    {0x9f,0xdf,0xdf,0xd3,0xcd,0xdd,0xdd,0xdd,0x88,0xff,0xff,0xff,0xff}, /* h */
    {0xf7,0xff,0xff,0xc7,0xf7,0xf7,0xf7,0xf7,0xc1,0xff,0xff,0xff,0xff}, /* i */
    {0xfb,0xff,0xff,0xc3,0xfb,0xfb,0xfb,0xfb,0xfb,0xfb,0xfb,0xc7,0xff}, /* j */
    {0x9f,0xdf,0xdf,0xd9,0xd7,0xcf,0xd7,0xdb,0x9c,0xff,0xff,0xff,0xff}, /* k */
    {0xc7,0xf7,0xf7,0xf7,0xf7,0xf7,0xf7,0xf7,0xc0,0xff,0xff,0xff,0xff}, /* l */
    {0xff,0xff,0xff,0x8b,0xd5,0xd5,0xd5,0xd5,0x94,0xff,0xff,0xff,0xff}, /* m */
    {0xff,0xff,0xff,0xa3,0xcd,0xdd,0xdd,0xdd,0x8c,0xff,0xff,0xff,0xff}, /* n */
    {0xff,0xff,0xff,0xe3,0xdd,0xdd,0xdd,0xdd,0xe3,0xff,0xff,0xff,0xff}, /* o */
    {0xff,0xff,0xff,0xa3,0xdd,0xdd,0xdd,0xdd,0xc3,0xdf,0xdf,0x8f,0xff}, /* p */
    {0xff,0xff,0xff,0xe2,0xdd,0xdd,0xdd,0xdd,0xe1,0xfd,0xfd,0xf8,0xff}, /* q */
    {0xff,0xff,0xff,0xd1,0xef,0xef,0xef,0xef,0xc3,0xff,0xff,0xff,0xff}, /* r */
    {0xff,0xff,0xff,0xe3,0xdd,0xe3,0xfd,0xdd,0xe3,0xff,0xff,0xff,0xff}, /* s */
    {0xff,0xef,0xef,0xc1,0xef,0xef,0xef,0xee,0xf1,0xff,0xff,0xff,0xff}, /* t */
    {0xff,0xff,0xff,0x99,0xdd,0xdd,0xdd,0xdd,0xe2,0xff,0xff,0xff,0xff}, /* u */
    {0xff,0xff,0xff,0x88,0xdd,0xdd,0xeb,0xe3,0xf7,0xff,0xff,0xff,0xff}, /* v */
    {0xff,0xff,0xff,0x88,0xdd,0xd5,0xd5,0xeb,0xeb,0xff,0xff,0xff,0xff}, /* w */
    {0xff,0xff,0xff,0x88,0xeb,0xf7,0xeb,0xdd,0x9c,0xff,0xff,0xff,0xff}, /* x */
    {0xff,0xff,0xff,0x88,0xdd,0xdd,0xeb,0xe3,0xf7,0xf7,0xf7,0xcf,0xff}, /* y */
    {0xff,0xff,0xff,0xc1,0xdb,0xf7,0xef,0xdd,0xc1,0xff,0xff,0xff,0xff}, /* z */
    {0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xef,0xff,0xff,0xff,0xff}, /* . */
    {0xfe,0xfd,0xfd,0xfb,0xfb,0xf7,0xf7,0xef,0xef,0xdf,0xff,0xff,0xff}, /* / */
    {0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff}  /*   */
};


/*
 * static declarations
 */
static char *program = NULL;
static char *pbmtext(char **str, int str_cnt, int *pbm_len);


main(int argc, char *argv[])
{
    int pbm_len;		/* image size in octets */
    char *pbm;			/* formed image */
    char *p;
    int i;

    /*
     * arg check
     */
    program = argv[0];
    if (argc < 2) {
	fprintf(stderr, "usage: %s line1 [line2 ...]\n", program);
	exit(1);
    }

    /*
     * create the pbm
     */
    pbm = pbmtext(argv+1, argc-1, &pbm_len);
    if (pbm == NULL) {
	fprintf(stderr, "%s: unable to form image\n", program);
	exit(3);
    }

    /*
     * write the PBM image
     */
    fwrite(pbm, pbm_len, 1, stdout);
    exit(0);
}


/*
 * pbmtext - allocate anbd load a pbm in memory
 *
 * given:
 *	char **str		array of pointers to string to load
 *	int str_cnt		number of strins in str
 *	int *pbm_len		point to where pbm image length is placed
 *
 * sets:
 *	*pbm_len	value is set to the full PBM image size in octets
 *
 * returns
 *	char *		pbm image (*pbm_len set ti size in octets) or NULL
 *
 * This function return NULL if passed a bad arg (str == NULL or str_cnt <= 0
 * or pbm_len == NULL); all strings in the string list are empty; the image
 * image is too large (> 2^31 octets).
 */
static char *
pbmtext(char **str, int str_cnt, int *pbm_len)
{
    int glyph_rows;	/* image rows in font chars */
    int glyph_cols;	/* image columns in font chars, longest arg in chars */
    unsigned char pbm_header[1+1+1+10+1+10+1+1];  /* tmp PMB header, max size */
    int pbm_header_len;				  /* actual PBM header length */
    char *pbm;		/* complete pmg image */
    char *row_p;	/* start of glyph row */
    int row;		/* current glyph row number */
    int pbm_size;	/* size in octets of the image after the header */
    char *p;
    char *q;
    int i;
    int j;

    /*
     * firewall
     */
    if (str == NULL || str_cnt <= 0 || pbm_len == NULL || str_cnt <= 0) {
	/* bogus arg */
	return NULL;
    }

    /*
     * determine the longest arg
     *
     * The longest string determines how wide (in terms of glyphs) the image 
     * will be.  The number of strings determine how tall (in terms of glyphs)
     * the image will be.
     */
    glyph_cols = 0;
    for (i=0; i < str_cnt; ++i) {
	if (strlen(str[i]) > glyph_cols) {
	    glyph_cols = strlen(str[i]);
	}
    }
    if (glyph_cols <= 0) {
	/* all strings are empty */
    	return NULL;
    }
    glyph_rows = str_cnt;

    /*
     * Catch the case where we would create an image that would exceed the
     * pbm_header size (10 digit pixel width or height) or that would create
     * an image > 2^31-1 octets in size.  We account the the extra guard
     * octet as well.
     */
    if ((long long)glyph_cols*GLYPH_PIXEL_COLS > 9999999999LL ||
    	(long long)glyph_rows*GLYPH_PIXEL_ROWS > 9999999999LL ||
        ((long long)glyph_cols * (long long)GLYPH_PIXEL_COLS *
	 (long long)glyph_rows * (long long)GLYPH_PIXEL_ROWS) >
	(0x7fffffffLL-((long long)sizeof(pbm_header)))-1) {
	/* size too large */
    	return NULL;
    }

    /*
     * determine what the final PBM header will look like
     */
    pbm_size = glyph_rows * GLYPH_PIXEL_ROWS * glyph_cols;
    sprintf((char *)pbm_header, "P4\n%d %d\n",
	    glyph_cols * GLYPH_PIXEL_COLS,
	    glyph_rows * GLYPH_PIXEL_ROWS);
    pbm_header_len = strlen(pbm_header);

    /*
     * allocate PBM image storage
     */
    pbm = (unsigned char *)malloc(pbm_header_len + pbm_size + 1);
    if (pbm == NULL) {
	/* malloc failure */
	return NULL;
    }

    /*
     * Initialize the PBM image
     *
     * We will set the image to black pixels and load PMB header.
     */
    strcpy(pbm, pbm_header);
    memset(pbm+pbm_header_len, 0xff, pbm_size);

    /*
     * fill in the image, one glyph row at a time
     */
    for (row_p = pbm + pbm_header_len, row=0;
    	 row < glyph_rows;
	 ++row, row_p += (GLYPH_PIXEL_ROWS * glyph_cols)) {

	int col;		/* current glyph column number */

	/*
	 * fill in the glyph image row, one column at a tme
	 */
	for (p = str[row], col = 0; col < glyph_cols; ++col) {

	    unsigned char *glyph;	/* current glyph to load */
	    unsigned char *col_p;	/* start of glyph col in row_p */
	    int gpix_row;		/* current pixel row in glpyh */

	    /*
	     * determine which glyph we will form
	     */
	    if (*p == '\0') {
		/* no glpyh, leave as default space, end of row */
	    	break;
	    } else {
		glyph = font[charnum[(int)*p++]];
	    }

	    /*
	     * load the glpyh, one pixel row at a time
	     */
	    for (col_p = row_p+col, gpix_row = 0;
	    	 gpix_row < GLYPH_PIXEL_ROWS;
		 ++gpix_row, col_p += glyph_cols) {
	    	*col_p = glyph[gpix_row];
	    }
	}
    }

    /*
     * deposit the real image size in octets
     */
    *pbm_len = pbm_header_len + pbm_size;

    /*
     * return the PBM
     */
    return pbm;
}
